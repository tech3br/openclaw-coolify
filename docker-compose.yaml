services:
  moltbot:
    build:
      context: .
      args:
        - MOLT_BOT_BETA=${MOLT_BOT_BETA:-false}
    restart: on-failure:10
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    env_file:
      - .env
    environment:
      PORT: 18789
      NODE_ENV: production
      NODE_OPTIONS: '--max-old-space-size=4096'
      HOME: /root
      TERM: xterm-256color
      
      # Map Moltbot vars to internal Clawdbot vars
      CLAWDBOT_GATEWAY_BIND: lan
      CLAWDBOT_GATEWAY_PORT: ${MOLTBOT_GATEWAY_PORT:-18789}
      # Tell the binary where to look for state/config
      MOLTBOT_STATE_DIR: /root/.moltbot
      MOLTBOT_WORKSPACE: /root/molt
      CLAWDBOT_STATE_DIR: /root/.moltbot
      CLAWDBOT_WORKSPACE: /root/molt

      # API Keys injected from .env or Coolify
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      MINIMAX_API_KEY: ${MINIMAX_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      KIMI_API_KEY: ${KIMI_API_KEY}
      MOONSHOT_API_KEY: ${KIMI_API_KEY}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      SANDBOX_CONTAINER: ${SANDBOX_CONTAINER:-false}
      
      # Optional integrations
      GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}
      NANOBANANA_API_KEY: ${NANOBANANA_API_KEY}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY}

      SERVICE_URL_MOLTBOT_18789: null
      BASE_URL: 'https://${SERVICE_FQDN_MOLTBOT}'
      PUBLIC_URL: 'https://${SERVICE_FQDN_MOLTBOT}'
      # Bootstrap controls
      CLAWDBOT_AUTO_BOOTSTRAP: "1"
      CLAWDBOT_PRINT_ACCESS: "1"
      GATEWAY_TRUSTED_PROXIES: '[*]'
      # Docker Socket Proxy
      DOCKER_HOST: tcp://docker-proxy:2375
      # Public URL Access
      CF_TUNNEL_TOKEN: ${CF_TUNNEL_TOKEN}
      # Deployment & Git
      VERCEL_ORG_ID: ${VERCEL_ORG_ID}
      VERCEL_PROJECT_ID: ${VERCEL_PROJECT_ID}
      VERCEL_TOKEN: ${VERCEL_TOKEN}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_USERNAME: ${GITHUB_USERNAME}
      # Optional
      MOLT_BOT_BETA: ${MOLT_BOT_BETA:-false}

    volumes:
      - moltbot-config:/root/.moltbot
      - moltbot-workspace:/root/molt
      - moltbot-linkding:/root/molt-linkding
      - moltbot-dbadmin:/root/molt-dbadmin
      # Secure: Socket mount removed in favor of proxy
      # - /var/run/docker.sock:/var/run/docker.sock

    depends_on:
      - docker-proxy

    command: ["bash", "/app/scripts/bootstrap.sh"]

  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      LOG_LEVEL: info
      # Security: Only enable necessary Docker APIs
      POST: 1       # Create containers
      CONTAINERS: 1 # List/manage containers
      IMAGES: 1     # Pull images
      NETWORKS: 1   # Connect to networks
      INFO: 1       # Version check
      VERSION: 1
      EVENTS: 1     # Listen for events (if needed)

  qdrant:
    image: qdrant/qdrant:latest
    restart: unless-stopped
    volumes:
      - qdrant-data:/qdrant/storage

  linkding:
    image: sissbruecker/linkding:latest
    restart: unless-stopped
    volumes:
      - linkding-data:/etc/linkding/data
    environment:
      - LD_DISABLE_BACKGROUND_TASKS=False
      - LD_DISABLE_URL_VALIDATION=False

  miniflux:
    image: miniflux/miniflux:latest
    restart: unless-stopped
    depends_on:
      - miniflux-db
    environment:
      - DATABASE_URL=postgres://miniflux:secret@miniflux-db/miniflux?sslmode=disable
      - RUN_MIGRATIONS=1
      - CREATE_ADMIN=1
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=admin123
      - BASE_URL=http://localhost:8080

  miniflux-db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=miniflux
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=miniflux
    volumes:
      - miniflux-db:/var/lib/postgresql/data

volumes:
  moltbot-config:
  moltbot-workspace:
  moltbot-linkding:
  moltbot-dbadmin:
  qdrant-data:
  linkding-data:
  miniflux-db: